<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>controller/person/PersonList.controller.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ErrorHandler.html">ErrorHandler</a></li></ul><h3>Modules</h3><ul><li><a href="module-Base.html">Base</a><ul class='methods'><li data-type='method'><a href="module-Base.html#~getFormActionFields">getFormActionFields</a></li><li data-type='method'><a href="module-Base.html#~getFormFields">getFormFields</a></li><li data-type='method'><a href="module-Base.html#~getFormInputFields">getFormInputFields</a></li><li data-type='method'><a href="module-Base.html#~getGUID">getGUID</a></li><li data-type='method'><a href="module-Base.html#~getID">getID</a></li><li data-type='method'><a href="module-Base.html#~getModel">getModel</a></li><li data-type='method'><a href="module-Base.html#~getResourceBundle">getResourceBundle</a></li><li data-type='method'><a href="module-Base.html#~getRouter">getRouter</a></li><li data-type='method'><a href="module-Base.html#~getUUID">getUUID</a></li><li data-type='method'><a href="module-Base.html#~hasErrorMessages">hasErrorMessages</a></li><li data-type='method'><a href="module-Base.html#~hasInvalidInput">hasInvalidInput</a></li><li data-type='method'><a href="module-Base.html#~hasMissingInput">hasMissingInput</a></li><li data-type='method'><a href="module-Base.html#~isValid">isValid</a></li><li data-type='method'><a href="module-Base.html#~onMessagesButtonPress">onMessagesButtonPress</a></li><li data-type='method'><a href="module-Base.html#~onNavBack">onNavBack</a></li><li data-type='method'><a href="module-Base.html#~sendBoxMessage">sendBoxMessage</a></li><li data-type='method'><a href="module-Base.html#~sendStripMessage">sendStripMessage</a></li><li data-type='method'><a href="module-Base.html#~sendToastMessage">sendToastMessage</a></li><li data-type='method'><a href="module-Base.html#~setModel">setModel</a></li></ul></li><li><a href="module-Component.html">Component</a><ul class='methods'><li data-type='method'><a href="module-Component.html#~destroy">destroy</a></li><li data-type='method'><a href="module-Component.html#~destroy">destroy</a></li><li data-type='method'><a href="module-Component.html#~init">init</a></li><li data-type='method'><a href="module-Component.html#~init">init</a></li></ul></li><li><a href="module-Organisation.html">Organisation</a><ul class='methods'><li data-type='method'><a href="module-Organisation.html#~hasInvalidInput">hasInvalidInput</a></li><li data-type='method'><a href="module-Organisation.html#~onInit">onInit</a></li><li data-type='method'><a href="module-Organisation.html#~onPatternMatched">onPatternMatched</a></li></ul></li><li><a href="module-OrganisationCreate.html">OrganisationCreate</a><ul class='methods'><li data-type='method'><a href="module-OrganisationCreate.html#~onPatternMatched">onPatternMatched</a></li></ul></li><li><a href="module-OrganisationList.html">OrganisationList</a></li><li><a href="module-Person.html">Person</a><ul class='methods'><li data-type='method'><a href="module-Person.html#~hasInvalidInput">hasInvalidInput</a></li><li data-type='method'><a href="module-Person.html#~onPatternMatched">onPatternMatched</a></li></ul></li><li><a href="module-PersonCreate.html">PersonCreate</a><ul class='methods'><li data-type='method'><a href="module-PersonCreate.html#~onPatternMatched">onPatternMatched</a></li></ul></li><li><a href="module-PersonList.html">PersonList</a></li><li><a href="module-Service.html">Service</a><ul class='methods'><li data-type='method'><a href="module-Service.html#~hasInvalidInput">hasInvalidInput</a></li><li data-type='method'><a href="module-Service.html#~onPatternMatched">onPatternMatched</a></li></ul></li><li><a href="module-ServiceCreate.html">ServiceCreate</a></li><li><a href="module-ServiceList.html">ServiceList</a></li><li><a href="module-Supplier.html">Supplier</a><ul class='methods'><li data-type='method'><a href="module-Supplier.html#~hasInvalidInput">hasInvalidInput</a></li><li data-type='method'><a href="module-Supplier.html#~onPatternMatched">onPatternMatched</a></li></ul></li><li><a href="module-SupplierCreate.html">SupplierCreate</a><ul class='methods'><li data-type='method'><a href="module-SupplierCreate.html#~onPatternMatched">onPatternMatched</a></li></ul></li><li><a href="module-SupplierList.html">SupplierList</a></li></ul><h3>Global</h3><ul><li><a href="global.html">Constructor</a></li><li><a href="global.html#onPatternMatched">onPatternMatched</a></li><li><a href="global.html#onRequestFailed">onRequestFailed</a></li><li><a href="global.html#showMetadataError">showMetadataError</a></li><li><a href="global.html#showServiceError">showServiceError</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">controller/person/PersonList.controller.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>sap.ui.define([
	"capetown/gov/registration/controller/person/Person.controller",
	"sap/ui/model/json/JSONModel",
	"sap/ui/model/Filter",
	"sap/ui/model/FilterOperator"
], function(PersonController, JSONModel, Filter, FilterOperator) {
	"use strict";
	
	/**
	 * Person list Controller
	 * @description Controller for person list
	 * @module PersonList
	 * @augments module:Person
	 */
	return PersonController.extend("capetown.gov.registration.controller.person.PersonList", {

		//Initializatin of this controller
		onInit: function() {

			//initialize
			this.initialize();

			//hook into route matched to adopt parameters for UI rendering
			this.getRouter().getRoute("PersonList").attachMatched(this.onPatternMatched, this);

			//set models: view model
			var oViewModel = new JSONModel({
				busy: false,
				delay: 0,
				itemToSelect: null,
				tableNoDataText: "No data",
				addEnabled: false
			});
			this.getView().setModel(oViewModel, "viewModel");
			this._oViewModel = oViewModel;

		},

		/**
		 *@memberOf capetown.gov.registration.controller.PersonList
		 */
		onPatternMatched: function(oEvent) {

			//Initialize variables
			this._oMessageStrip.setVisible(false);

			//trigger refresh of list
			this.getView().byId("tabPersonList").getBinding("items").refresh();
			
			//prepare view model for cobrowse mode
			this.adoptComponentAttributes("Cobrowse", this._oViewModel);

			//build new filter to exclude logged on person from the list of people
			var oFilter = [new Filter({
				path: "PersonID",
				operator: FilterOperator.NE,
				value1: this.getOwnerComponent().oUserInfo.PersonID,
				and: false
			})];

			//apply filter to person list and set appropriate noData text where applicable
			if (this.getView().byId("tabPersonList").getBinding("items").filter(oFilter).getLength() === 0) {
				this._oViewModel.setProperty("/tableNoDataText", "No entries. Click + to add");
			}

		},

		/**
		 *@memberOf capetown.gov.registration.controller.PersonList
		 * Event handler for 'Press' on PersonList
		 */
		onPersonListItemPress: function(oEvent) {

			//prepare object path to be passed on to target
			this.getModel("viewModel").setProperty("/addEnabled", false);
			var oListItem = oEvent.getParameter("listItem") || oEvent.getSource();
			var oContext = oListItem.getBindingContext("Registration");
			var sPersonID = oContext.getProperty("PersonID");

			//Navigate to the administrator details view providing the administrator ID
			this.getRouter().navTo("Person", {
				mode: "update",
				PersonID: sPersonID
			});

		},

		//on quick filter search
		onPersonSearch: function(oEvent) {

			//local data declaration
			var sQuery;

			//get search query for list filtering
			switch (oEvent.sId) {
				case "liveChange":
					var oSearchField = oEvent.getSource();
					sQuery = oSearchField.getValue();
					break;
				default:
					sQuery = oEvent.getParameter("query");
			}

			//build array of filters for searching people
			var aFilters = [new sap.ui.model.Filter({
				filters: [
					new sap.ui.model.Filter({
						and: false,
						filters: [
							new sap.ui.model.Filter({
								path: "eMailAddress",
								operator: "Contains",
								value1: sQuery
							}),
							new sap.ui.model.Filter({
								path: "Name",
								operator: "Contains",
								value1: sQuery
							}),
							new sap.ui.model.Filter({
								path: "Surname",
								operator: "Contains",
								value1: sQuery
							}),
							new sap.ui.model.Filter({
								path: "IDType",
								test: function(sValue) {
									var oRegExp = new RegExp(sQuery, "i"); //case insensitive search
									var sIDTypeText = this.formatIDType(sValue);
									if (oRegExp.test(sIDTypeText)) {
										return true;
									} else {
										return false;
									}
								}.bind(this)
							}),
							new sap.ui.model.Filter({
								path: "IDNumber",
								operator: "Contains",
								value1: sQuery
							}),
							new sap.ui.model.Filter({
								path: "eMailAddress",
								operator: "Contains",
								value1: sQuery
							}),
							new sap.ui.model.Filter({
								path: "PhoneNumber",
								operator: "Contains",
								value1: sQuery
							}),
							new sap.ui.model.Filter({
								path: "EntityStatusID",
								test: function(sValue) {
									var oRegExp = new RegExp(sQuery, "i"); //case insensitive search
									var sEntityStatusText = this.formatEntityStatusID(sValue);
									if (oRegExp.test(sEntityStatusText)) {
										return true;
									} else {
										return false;
									}
								}.bind(this)
							})
						]
					})
				]
			})];

			//exclude logged on person from search result set
			aFilters.push(new Filter({
				path: "PersonID",
				operator: FilterOperator.NE,
				value1: this.getOwnerComponent().oUserInfo.PersonID,
				and: true
			}));

			// changes the noDataText of the list in case there are no filter results
			if (this.getView().byId("tabPersonList").getBinding("items").filter(aFilters).getLength() !== 0) {
				this._oViewModel.setProperty("/tableNoDataText", this.getResourceBundle().getText("listNoDataWithQuickFilterSearch"));
			}

		},

		//add person
		onPressPersonAddButton: function() {

			//Navigate to Administrator Details view for create
			this.getRouter().navTo("PersonCreate");

		},

		//delete person
		onPressPersonDeleteButton: function(oEvent) {

			//get context pointing to person for deletion
			var oContext = oEvent.getSource().getParent().getBindingContext("Registration");
			
			//get person attributes
			var oPerson = this._oODataModel.getObject(oContext.getPath());
			
			//check person is not in submitted status
			if(oPerson.EntityStatusID === "1"){
				
				//message handling: no delete for submitted entity
				this.sendStripMessage(this.getResourceBundle().getText("messageNoDeleteOfSubmittedPersonEntity"), sap.ui.core.MessageType.Error);

				//no further processing
				return;
				
			}

			//check whether this person is still related
			if (this.isRelated(oContext)) {

				//message handling: no delated for related entity
				this.sendStripMessage(this.getResourceBundle().getText("messageNoDeleteOfPersonRelatedEntity"), sap.ui.core.MessageType.Error);

				//no further processing
				return;

			}

			//confirmation dialog to delete this person
			sap.m.MessageBox.confirm("Delete " + oPerson.Name + " " + oPerson.Surname + "?", {
				actions: [
					sap.m.MessageBox.Action.YES,
					sap.m.MessageBox.Action.CANCEL
				],

				//on confirmation dialog close
				onClose: (function(oAction) {

					//user choice: proceed with deletion
					if (oAction === sap.m.MessageBox.Action.YES) {

						//delete service from backend
						this._oODataModel.remove(oContext.getPath(), {

							//service entity deleted successfully
							success: (function() {

								//message handling
								this._oMessageStrip.setText(this._oResourceBundle.getText("deleteModelEntitySuccessful"));
								this._oMessageStrip.setType(sap.ui.core.MessageType.Success);
								this._oMessageStrip.setVisible(true);

								//post processing after successful updating in the backend
								this._oViewModel.setProperty("/busy", false);

							}).bind(this)

						});

					}

				}).bind(this)

			});

		},

		//sort entity list in alternating order
		onPressPersonListSort: function() {

			//default sort direction
			if (this.bListSortDescending === undefined) {
				this.bListSortDescending = true;
			}

			//toggle list sort direction
			this.bListSortDescending = !this.bListSortDescending;

			//sort entity list in opposite direction
			this.byId("tabPersonList").getBinding("items").sort([new sap.ui.model.Sorter("Name", this.bListSortDescending)]);

		}

	});

});</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.4</a> on Wed Sep 27 2017 15:03:10 GMT+0300 (E. Europe Daylight Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
