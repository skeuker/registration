<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>controller/service/ServiceList.controller.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="ErrorHandler.html">ErrorHandler</a></li></ul><h3>Modules</h3><ul><li><a href="module-Base.html">Base</a><ul class='methods'><li data-type='method'><a href="module-Base.html#~getFormActionFields">getFormActionFields</a></li><li data-type='method'><a href="module-Base.html#~getFormFields">getFormFields</a></li><li data-type='method'><a href="module-Base.html#~getFormInputFields">getFormInputFields</a></li><li data-type='method'><a href="module-Base.html#~getGUID">getGUID</a></li><li data-type='method'><a href="module-Base.html#~getID">getID</a></li><li data-type='method'><a href="module-Base.html#~getModel">getModel</a></li><li data-type='method'><a href="module-Base.html#~getResourceBundle">getResourceBundle</a></li><li data-type='method'><a href="module-Base.html#~getRouter">getRouter</a></li><li data-type='method'><a href="module-Base.html#~getUUID">getUUID</a></li><li data-type='method'><a href="module-Base.html#~hasErrorMessages">hasErrorMessages</a></li><li data-type='method'><a href="module-Base.html#~hasInvalidInput">hasInvalidInput</a></li><li data-type='method'><a href="module-Base.html#~hasMissingInput">hasMissingInput</a></li><li data-type='method'><a href="module-Base.html#~isValid">isValid</a></li><li data-type='method'><a href="module-Base.html#~onMessagesButtonPress">onMessagesButtonPress</a></li><li data-type='method'><a href="module-Base.html#~onNavBack">onNavBack</a></li><li data-type='method'><a href="module-Base.html#~sendBoxMessage">sendBoxMessage</a></li><li data-type='method'><a href="module-Base.html#~sendStripMessage">sendStripMessage</a></li><li data-type='method'><a href="module-Base.html#~sendToastMessage">sendToastMessage</a></li><li data-type='method'><a href="module-Base.html#~setModel">setModel</a></li></ul></li><li><a href="module-Component.html">Component</a><ul class='methods'><li data-type='method'><a href="module-Component.html#~destroy">destroy</a></li><li data-type='method'><a href="module-Component.html#~destroy">destroy</a></li><li data-type='method'><a href="module-Component.html#~init">init</a></li><li data-type='method'><a href="module-Component.html#~init">init</a></li></ul></li><li><a href="module-Organisation.html">Organisation</a><ul class='methods'><li data-type='method'><a href="module-Organisation.html#~hasInvalidInput">hasInvalidInput</a></li><li data-type='method'><a href="module-Organisation.html#~onInit">onInit</a></li><li data-type='method'><a href="module-Organisation.html#~onPatternMatched">onPatternMatched</a></li></ul></li><li><a href="module-OrganisationCreate.html">OrganisationCreate</a><ul class='methods'><li data-type='method'><a href="module-OrganisationCreate.html#~onPatternMatched">onPatternMatched</a></li></ul></li><li><a href="module-OrganisationList.html">OrganisationList</a></li><li><a href="module-Person.html">Person</a><ul class='methods'><li data-type='method'><a href="module-Person.html#~hasInvalidInput">hasInvalidInput</a></li><li data-type='method'><a href="module-Person.html#~onPatternMatched">onPatternMatched</a></li></ul></li><li><a href="module-PersonCreate.html">PersonCreate</a><ul class='methods'><li data-type='method'><a href="module-PersonCreate.html#~onPatternMatched">onPatternMatched</a></li></ul></li><li><a href="module-PersonList.html">PersonList</a></li><li><a href="module-Service.html">Service</a><ul class='methods'><li data-type='method'><a href="module-Service.html#~hasInvalidInput">hasInvalidInput</a></li><li data-type='method'><a href="module-Service.html#~onPatternMatched">onPatternMatched</a></li></ul></li><li><a href="module-ServiceCreate.html">ServiceCreate</a></li><li><a href="module-ServiceList.html">ServiceList</a></li><li><a href="module-Supplier.html">Supplier</a><ul class='methods'><li data-type='method'><a href="module-Supplier.html#~hasInvalidInput">hasInvalidInput</a></li><li data-type='method'><a href="module-Supplier.html#~onPatternMatched">onPatternMatched</a></li></ul></li><li><a href="module-SupplierCreate.html">SupplierCreate</a><ul class='methods'><li data-type='method'><a href="module-SupplierCreate.html#~onPatternMatched">onPatternMatched</a></li></ul></li><li><a href="module-SupplierList.html">SupplierList</a></li></ul><h3>Global</h3><ul><li><a href="global.html">Constructor</a></li><li><a href="global.html#onPatternMatched">onPatternMatched</a></li><li><a href="global.html#onRequestFailed">onRequestFailed</a></li><li><a href="global.html#showMetadataError">showMetadataError</a></li><li><a href="global.html#showServiceError">showServiceError</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">controller/service/ServiceList.controller.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>sap.ui.define([
	"capetown/gov/registration/controller/service/Service.controller",
	"sap/ui/model/json/JSONModel"
], function(ServiceController, JSONModel) {
	"use strict";
	
	/**
	 * Service list Controller
	 * @description Controller for service list
	 * @module ServiceList
	 * @augments module:Service
	 */
	return ServiceController.extend("capetown.gov.registration.controller.service.ServiceList", {

		//Initialization of this controller
		onInit: function() {

			//initialize
			this.initialize();

			//hook into route matched to adopt parameters for UI rendering
			this.getRouter().getRoute("ServiceList").attachMatched(this.onPatternMatched, this);

			//set models: view model
			var oViewModel = new JSONModel({
				tableNoDataText: this.getResourceBundle().getText("tableNoDataTextWithAddOption"),
				busy: false,
				delay: 0
			});
			this.getView().setModel(oViewModel, "viewModel");
			this._oViewModel = oViewModel;

		},

		/**
		 *@memberOf capetown.gov.registration.controller.ServiceList
		 */
		onPatternMatched: function(oEvent) {

			//Initialize variables
			this._oMessageStrip.setVisible(false);

			//prepare view model for cobrowse mode
			this.adoptComponentAttributes("Cobrowse", this._oViewModel);

			//trigger refresh of list
			this.getView().byId("tabServiceList").getBinding("items").refresh();

		},

		/**
		 *@memberOf capetown.gov.registration.controller.ServiceList
		 */
		onCBoxServiceTypesChange: function(oEvent) {

			//disable service add button if no service type selected
			var oCBoxServiceTypes = oEvent.getSource();
			if (!oCBoxServiceTypes.getSelectedItem()) {
				this.getView().byId("btnServiceAdd").setEnabled(false);
				return;
			}

			//enable creation of service
			this.getView().byId("btnServiceAdd").setEnabled(true);

		},

		/**
		 *@memberOf capetown.gov.registration.controller.ServiceList
		 * Event handler for 'Press' on ServiceList
		 */
		onPressServiceListItem: function(oEvent) {

			//prepare object path to be passed on to target
			var oListItem = oEvent.getParameter("listItem") || oEvent.getSource();
			var oContext = oListItem.getBindingContext("Registration");
			var sServiceID = oContext.getProperty("ServiceID");

			//Navigate to service details view providing the service ID
			this.getRouter().navTo("Service", {
				ServiceID: sServiceID
			});

		},

		/**
		 *@memberOf capetown.gov.registration.controller.App
		 */
		onPressServiceAddButton: function(oEvent) {

			//double check a service type is selected
			var oServiceType = this.getView().byId("cboxServiceTypes");
			if (!oServiceType.getSelectedKey()) {
				oServiceType.setValueState(sap.ui.core.ValueState.Error);
				oServiceType.setValueStateText("Select the type of service to add");
				return;
			}

			//reset value state and text of service type in case of previous error
			oServiceType.setValueState(sap.ui.core.ValueState.None);

			//create service scope popover
			this.oServiceScopePopover = sap.ui.xmlfragment("capetown.gov.registration.fragment.service.ServiceScopePopoverWithoutServiceType",
				this);
			this.oServiceScopePopover.attachAfterClose(function() {
				this.oServiceScopePopover.destroy();
			}.bind(this));
			this.getView().addDependent(this.oServiceScopePopover);

			//delay because addDependent will do a async rerendering 
			var oLabelServiceType = this.getView().byId("labelServiceType");
			jQuery.sap.delayedCall(0, this, function() {
				this.oServiceScopePopover.openBy(oLabelServiceType);
			}.bind(this));

		},

		/**
		 *@memberOf capetown.gov.registration.controller.App
		 */
		onPressPersonServiceAddButton: function() {

			//local data declaration
			var sServiceCreateRouteID;

			//get chosen service type
			var sServiceTypeID = this.getView().byId("cboxServiceTypes").getSelectedKey();

			//check whether person is already registered for this service
			if (this.isDuplicateInputForPerson()) {
				return;
			}

			//Create object path for existing person OData model instance
			var sPersonKey = "/" + this.getModel("Registration").createKey("PersonSet", {
				PersonID: this.getOwnerComponent().oUserInfo.PersonID
			});

			//get person entity
			var oPerson = this.getModel("Registration").getObject(sPersonKey);

			//for person with 'adopted' business partner that is already supplier
			if (oPerson.isAdopted &amp;&amp; oPerson.isSupplier) {

				//message handling: person status not suitable
				if (oPerson.EntityStatusID !== "1" &amp;&amp; oPerson.EntityStatusID !== "2") {
					this.sendStripMessage(this.getResourceBundle().getText("messagePersonProfileNeedsUpdating"), sap.ui.core.MessageType.Error);
					return;
				}

				//confirmation dialog to submit
				sap.m.MessageBox.confirm(this.getResourceBundle().getText("messageConfirmSubmitRegistration"), {
					actions: [
						sap.m.MessageBox.Action.YES,
						sap.m.MessageBox.Action.NO
					],

					//on confirmation dialog close
					onClose: function(oAction) {

						//submit wizard content for posting
						if (oAction === sap.m.MessageBox.Action.YES) {

							//set view to busy
							this.getModel("viewModel").setProperty("/busy", true);

							//create new supplier self service set entry 
							var oServiceContext = this._oODataModel.createEntry("ServiceSet", {
								properties: {
									ServiceID: this.getUUID(),
									PersonID: this.getOwnerComponent().oUserInfo.PersonID,
									ServiceTypeID: "SupplierSelfService",
									ServiceScopeID: "0", //Person
									EntityStatusID: "1", //Submitted
									LastActionID: "1", //Submitted
									LastActionTimeStamp: new Date(),
									isAdministered: true
								}
							});

							//submit all changes made to model content
							this._oODataModel.submitChanges({

								//update success handler
								success: function(oData, oResponse) {

									//get entity from backend and confirm submission
									this.promiseToReadEntity(oServiceContext).then(function(oEntity) {
										
										//close service scope popover
										this.oServiceScopePopover.close();

										//refresh list of service registrations
										this.getView().byId("tabServiceList").getBinding("items").refresh();

										//set view to no longer busy
										this.getModel("viewModel").setProperty("/busy", false);

										//confirm submission	
										this.confirmSubmission(oEntity, false);

									}.bind(this));

								}.bind(this)

							});

						}

					}.bind(this)

				});

				//no further processing at this stage
				return;

			}

			//decide on route depending on service type
			sServiceCreateRouteID = this.getServiceRouteID(sServiceTypeID, "Create", "Person");

			//Navigate to person service create wizard 
			this.getRouter().navTo(sServiceCreateRouteID, {
				PersonID: this.getOwnerComponent().oUserInfo.PersonID
			});

		},

		/**
		 *@memberOf capetown.gov.registration.controller.ServiceList
		 */
		onPressOrganisationServiceAddButton: function() {

			//get chosen service type
			var sServiceTypeID = this.getView().byId("cboxServiceTypes").getSelectedKey();

			//decide on route depending on service type
			var sServiceCreateRouteID = this.getServiceRouteID(sServiceTypeID, "Create", "Organisation");

			//Navigate to service create wizard to create service
			this.getRouter().navTo(sServiceCreateRouteID, {
				ServiceScopeID: "1"
			});

		},

		//delete service
		onPressServiceDeleteButton: function(oEvent) {

			//local data declaration
			var sConfirmationText;

			//get context pointing to person for deletion
			var oContext = oEvent.getSource().getParent().getBindingContext("Registration");

			//get service attributes
			var oService = this._oODataModel.getObject(oContext.getPath());

			//check service is not in submitted status
			if (oService.EntityStatusID === "1") {

				//message handling: no delete for submitted entity
				this.sendStripMessage(this.getResourceBundle().getText("messageNoDeleteOfSubmittedServiceEntity"), sap.ui.core.MessageType.Error);

				//no further processing
				return;

			}

			//build confirmation text for person service deletion
			if (oService.PersonID) {
				sConfirmationText = "Delete service " + this.formatServiceTypeID(oService.ServiceTypeID) + " for " + this.formatPersonID(oService.PersonID) +
					"?";
			}

			//build confirmation text for organisation service deletion
			if (oService.OrganisationID) {
				sConfirmationText = "Delete service " + this.formatServiceTypeID(oService.ServiceTypeID) + " for " + this.formatOrganisationID(
					oService.OrganisationID) + "?";
			}

			//confirmation dialog to delete this organisation
			sap.m.MessageBox.confirm(sConfirmationText, {
				actions: [
					sap.m.MessageBox.Action.YES,
					sap.m.MessageBox.Action.CANCEL
				],

				//on confirmation dialog close
				onClose: (function(oAction) {

					//user choice: proceed with deletion
					if (oAction === sap.m.MessageBox.Action.YES) {

						//delete service from backend
						this._oODataModel.remove(oContext.getPath(), {

							//service entity deleted successfully
							success: (function() {

								//message handling
								this._oMessageStrip.setText(this._oResourceBundle.getText("deleteModelEntitySuccessful"));
								this._oMessageStrip.setType(sap.ui.core.MessageType.Success);
								this._oMessageStrip.setVisible(true);

								//post processing after successful updating in the backend
								this._oViewModel.setProperty("/busy", false);

							}).bind(this)

						});

					}

				}).bind(this)

			});

		}

	});

});</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.4</a> on Wed Sep 27 2017 15:03:10 GMT+0300 (E. Europe Daylight Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
